<html><head></head><body>
		<div id="_idContainer096">
			<h1 id="_idParaDest-126"><em class="italic"><a id="_idTextAnchor129"/>Chapter 9</em>: Working with Multimodal and Multitasking Data</h1>
			<p>In this chapter, we will learn how to use the AutoModel API to handle multimodal and multitasking data.</p>
			<p>By the end of this chapter, you will have learned how to use the concepts and tools necessary to create models with multiple inputs and multiple outputs. You will be able to apply these concepts to your own projects by creating a model from scratch or by adapting the practical example shown in this chapter to other, similar datasets.  </p>
			<p>In this chapter, we will cover the following topics:</p>
			<ul>
				<li>Exploring models with multiple input or outputs</li>
				<li>Creating a multitasking/multimodal model </li>
				<li>Customizing the search space</li>
			</ul>
			<p>But first, let's explain the technical requirements for this chapter.</p>
			<h1 id="_idParaDest-127"><a id="_idTextAnchor130"/>Technical requirements </h1>
			<p>All the code examples in this book are available as Jupyter notebooks that can be downloaded from <a href="https://github.com/PacktPublishing/Automated-Machine-Learning-with-AutoKeras">https://github.com/PacktPublishing/Automated-Machine-Learning-with-AutoKeras</a>.</p>
			<p>Since code cells can be executed, each notebook can be self-installed; simply add the code snippet that contains the requirements you need. For this reason, at the beginning of each notebook, there is a code cell for environment setup that installs AutoKeras and its dependencies.</p>
			<p>So, to run the code examples in this chapter, you only need a computer with Ubuntu Linux as its OS and must install the Jupyter Notebook with the following line of code:</p>
			<p class="source-code">$ apt-get install python3-pip jupyter-notebook</p>
			<p>Alternatively, you can also run these notebooks using Google Colaboratory, in which case you will only need a web browser. See <a href="B16953_02_Final_PG_ePub.xhtml#_idTextAnchor029"><em class="italic">Chapter 2</em></a>, <em class="italic">AutoKeras with Google Colaboratory</em>, for more details. Furthermore, in the <em class="italic">Installing AutoKeras</em> section of that chapter, you will find other installation options.</p>
			<p>Now, let's put these concepts we mentioned in the introduction into practice by looking at a practical example.</p>
			<h1 id="_idParaDest-128"><a id="_idTextAnchor131"/>Exploring models with multiple inputs or outputs</h1>
			<p>As we will <a id="_idIndexMarker331"/>see later, sometimes, it may interest us that our model feeds on information from different sources (multimodal) and/or predicts multiple targets at the same time (multitask). AutoKeras has a class called <strong class="bold">AutoModel</strong> that allows us to define several sources and targets as a list of parameters. Let's dive a little deeper into this before looking at a practical example.</p>
			<h2 id="_idParaDest-129"><a id="_idTextAnchor132"/>What is AutoModel?</h2>
			<p>AutoModel is a <a id="_idIndexMarker332"/>class that allows us to define a model in a granular way by defining not only its inputs and outputs but also its intermediate layers.</p>
			<p>It can be used in <a id="_idIndexMarker333"/>two different ways:</p>
			<ul>
				<li><strong class="bold">Basic</strong>: Here, the input/output nodes are specified and AutoModel infers the remaining part of the model.</li>
				<li><strong class="bold">Advanced</strong>: Here, the high-level architecture is defined by connecting the layers (blocks) with the Functional API, which is the same as the Keras functional API.</li>
			</ul>
			<p>Let's look at an example of each one.</p>
			<h3>Basic example</h3>
			<p>The user only <a id="_idIndexMarker334"/>specifies the input nodes and output heads:</p>
			<p class="source-code">import autokeras as ak</p>
			<p class="source-code">ak.AutoModel(</p>
			<p class="source-code">    inputs=[ak.ImageInput(), ak.TextInput()],</p>
			<p class="source-code">    outputs[ak.ClassificationHead(), ak.RegressionHead()])</p>
			<p>Next, let's look at an advanced example.</p>
			<h3>Advanced example</h3>
			<p>The user <a id="_idIndexMarker335"/>specifies the high-level architecture:</p>
			<p class="source-code">import autokeras as ak</p>
			<p class="source-code">image_input = ak.ImageInput()</p>
			<p class="source-code">image_output = ak.ImageBlock()(image_input)</p>
			<p class="source-code">text_input = ak.TextInput()</p>
			<p class="source-code">text_output = ak.TextBlock()(text_input)</p>
			<p class="source-code">output = ak.Merge()([image_output, text_output])</p>
			<p class="source-code">classification_output = ak.ClassificationHead()(output)</p>
			<p class="source-code">regression_output = ak.RegressionHead()(output)</p>
			<p class="source-code">ak.AutoModel(</p>
			<p class="source-code">   inputs=[image_input, text_input],</p>
			<p class="source-code">   outputs=[classification_output, regression_output])</p>
			<p>In the preceding code, we configured AutoModel to create a model with multiple inputs (multimodal) and several outputs (multitask). Next, we will explain these concepts and see them in action by creating our own multimodel.</p>
			<h2 id="_idParaDest-130"><a id="_idTextAnchor133"/>What is multimodal?</h2>
			<p>We say that data is <a id="_idIndexMarker336"/>multimodal when each data instance contains multiple forms of information. For example, we can save a photo as an image, but in addition to that image, it also contains <em class="italic">meta</em> information about where it was taken. This meta information can be treated as structured data.</p>
			<h2 id="_idParaDest-131"><a id="_idTextAnchor134"/>What is multitask?</h2>
			<p>We say that a model is <a id="_idIndexMarker337"/>multitask when it predicts multiple targets with the same input features. For example, let's say we want to classify photos of people by ethnic groups, but at the same time, we want to specify their age as a number between 0 and 100.</p>
			<p>The following diagram shows an example of a multimodal and multitask neural network model:</p>
			<div>
				<div id="_idContainer092" class="IMG---Figure">
					<img src="image/B16953_09_01.jpg" alt="Figure 9.1 – Example of a multimodal and multitask neural network model&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.1 – Example of a multimodal and multitask neural network model</p>
			<p>Here, we can see that there are two entries: <strong class="bold">images</strong> (<strong class="bold">ImageInput</strong>) and <strong class="bold">structured data</strong> (<strong class="bold">StructuredDataInput</strong>). Each image is associated with a set of attributes in the structured <a id="_idIndexMarker338"/>data. From this data, we can try to predict the <strong class="bold">classification label</strong> (<strong class="bold">ClassificationHead</strong>) and the <strong class="bold">regression value</strong> (<strong class="bold">RegressionHead</strong>) at the same time.</p>
			<p>Let's look at these concepts in more detail by looking at a practical example.</p>
			<h1 id="_idParaDest-132"><a id="_idTextAnchor135"/>Creating a multitask/multimodal model</h1>
			<p>Based on the example <a id="_idIndexMarker339"/>provided at the beginning of this chapter, the model that we are going to create will take an image and its structured data attributes as input and will predict a category value and a scalar value. In this case, instead of using a dataset, we will generate our own data. The notebook we will be using that contains the complete source code can be found at <a href="https://github.com/PacktPublishing/Automated-Machine-Learning-with-AutoKeras/blob/main/Chapter09/Chapter9_MultiModel.ipynb">https://github.com/PacktPublishing/Automated-Machine-Learning-with-AutoKeras/blob/main/Chapter09/Chapter9_MultiModel.ipynb</a>.</p>
			<p>Now, let's have a look at the relevant cells of the notebook in detail:</p>
			<ul>
				<li><strong class="bold">Installing AutoKeras</strong>: As we've mentioned in the previous chapters, this snippet at the top of the notebook is responsible for installing AutoKeras and its dependencies using the pip package manager:<p class="source-code">!pip3 install autokeras</p></li>
				<li><strong class="bold">Importing the necessary packages</strong>: The following lines load TensorFlow, the built-in Keras Reuters dataset, <strong class="source-inline">numpy</strong>, and <strong class="source-inline">AutoKeras</strong> as the necessary dependencies for this project:<p class="source-code">import numpy as np</p><p class="source-code">import autokeras as ak</p></li>
				<li><strong class="bold">Creating the datasets</strong>: First, we are going to create the datasets by generating a random image and structured data as multimodal data:<p class="source-code">import numpy as npnum_instances = 100</p><p class="source-code">image_data = np.random.rand(num_instances, 32, 32, 3).astype(np.float32)</p><p class="source-code">structured_data = np.random.rand(num_instances, 20).astype(np.float32)</p><p>Now, generate some multitask targets for classification and regression:</p><p class="source-code">regression_target = np.random.rand(num_instances, 1).astype(np.float32)</p><p class="source-code">classification_target = np.random.randint(5, size=num_instances)</p></li>
			</ul>
			<p>Now, it's <a id="_idIndexMarker340"/>time to create the model.</p>
			<h2 id="_idParaDest-133"><a id="_idTextAnchor136"/>Creating the model</h2>
			<p>Now, we will create <a id="_idIndexMarker341"/>the model using <strong class="source-inline">AutoModel</strong>, first in its basic configuration and then in its advanced one. As in the previous examples, we will set a small amount of <strong class="source-inline">max_trials</strong> and <strong class="source-inline">epochs</strong> so that the training process doesn't take too long.</p>
			<p>First, we will initialize the model with multiple inputs and outputs:</p>
			<p class="source-code">import autokeras as akmodel = ak.AutoModel(</p>
			<p class="source-code">    inputs=[ak.ImageInput(), ak.StructuredDataInput()],</p>
			<p class="source-code">    outputs=[</p>
			<p class="source-code">        ak.RegressionHead(metrics=['mae']),</p>
			<p class="source-code">        ak.ClassificationHead(loss='categorical_crossentropy', metrics=['accuracy'])</p>
			<p class="source-code">    ],</p>
			<p class="source-code">    overwrite=True,</p>
			<p class="source-code">    max_trials=2)</p>
			<p>In the previous code, we have defined two inputs (image and structured data) and two outputs (regression and classification). Here, we are telling the model that we want to train our input data with a regressor and a classifier at the same time.</p>
			<p>Now, let's run the training process to search for the optimal model for the training dataset:</p>
			<p class="source-code">model.fit(</p>
			<p class="source-code">    [image_data, structured_data],</p>
			<p class="source-code">    [regression_target, classification_target],</p>
			<p class="source-code">    epochs=3)</p>
			<p>Here's the output:</p>
			<div>
				<div id="_idContainer093" class="IMG---Figure">
					<img src="image/B16953_09_02.jpg" alt="Figure 9.2 – Notebook output of model training&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.2 – Notebook output of model training</p>
			<p>Unlike the previous <a id="_idIndexMarker342"/>examples, here, we can see that the output shows two losses – one for the regressor and one for the classifier. In this case, the data is generated randomly, so there is no point in looking at performance for evaluation.</p>
			<h2 id="_idParaDest-134"><a id="_idTextAnchor137"/>Visualizing the model</h2>
			<p>Now, let's look at a little <a id="_idIndexMarker343"/>summary of the architecture for the best generated model:</p>
			<p class="source-code">keras_model = model.export_model()</p>
			<p class="source-code">keras_model.summary()</p>
			<p>Here is the output:</p>
			<div>
				<div id="_idContainer094" class="IMG---Figure">
					<img src="image/B16953_09_03.jpg" alt="Figure 9.3 – Best model architecture summary&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.3 – Best model architecture summary</p>
			<p>Let's briefly describe <a id="_idIndexMarker344"/>the blocks that were used for this model.</p>
			<p>In this case, AutoKeras creates two submodels – one for each piece of input data. It has chosen a deep residual network architecture (<strong class="bold">resnet50</strong>), which we already presented in <a href="B16953_04_Final_PG_ePub.xhtml#_idTextAnchor063"><em class="italic">Chapter 4</em></a>, <em class="italic">Image Classification and Regression using AutoKeras</em>, to process the image data and a couple of fully connected layers to ingest the structured data. After digesting the two data sources, the results of both submodels are concatenated and separated again to generate the two different outputs (a scalar value and a category value).</p>
			<p>Here is a visual representation of this:</p>
			<div>
				<div id="_idContainer095" class="IMG---Figure">
					<img src="image/B16953_09_04.jpg" alt="Figure 9.4 – Best model architecture visualization"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.4 – Best model architecture visualization</p>
			<p>Now, let's use <a id="_idIndexMarker345"/>AutoModel in a more advanced mode to customize the intermediate blocks.</p>
			<h1 id="_idParaDest-135"><a id="_idTextAnchor138"/>Customizing the search space</h1>
			<p>As we mentioned <a id="_idIndexMarker346"/>at the beginning of this chapter, there is an advanced way to use AutoModel. We can do this by defining the whole model architecture by connecting the layers (blocks) with the functional API, which is the same as the Keras functional API.</p>
			<p>Let's do this in the following example:</p>
			<p class="source-code">input_node1 = ak.ImageInput()</p>
			<p class="source-code">output_node = ak.Normalization()(input_node1)</p>
			<p class="source-code">output_node = ak.ImageAugmentation()(output_node)</p>
			<p class="source-code">output_node1 = ak.ConvBlock()(output_node)</p>
			<p class="source-code">output_node2 = ak.ResNetBlock(version='v2')(output_node)</p>
			<p class="source-code">output_node1 = ak.Merge()([output_node1, output_node2])</p>
			<p class="source-code"> </p>
			<p class="source-code">input_node2 = ak.StructuredDataInput()</p>
			<p class="source-code">output_node = ak.CategoricalToNumerical()(input_node2)</p>
			<p class="source-code">output_node2 = ak.DenseBlock()(output_node)</p>
			<p class="source-code"> </p>
			<p class="source-code">output_node = ak.Merge()([output_node1, output_node2])</p>
			<p class="source-code">output_node1 = ak.ClassificationHead()(output_node)</p>
			<p class="source-code">output_node2 = ak.RegressionHead()(output_node)</p>
			<p class="source-code"> </p>
			<p class="source-code">model = ak.AutoModel(</p>
			<p class="source-code">    inputs=[input_node1, input_node2], </p>
			<p class="source-code">    outputs=[output_node1, output_node2],</p>
			<p class="source-code">    overwrite=True,</p>
			<p class="source-code">    max_trials=2)</p>
			<p class="source-code"> </p>
			<p class="source-code">model.fit(</p>
			<p class="source-code">    [image_data, structured_data],</p>
			<p class="source-code">    [classification_target, regression_target],</p>
			<p class="source-code">    batch_size=32,</p>
			<p class="source-code">    epochs=3)</p>
			<p>Here, we have defined each block <a id="_idIndexMarker347"/>sequentially by connecting the output of one to the input of the next. In this case, we've customized the model by adding some image preprocessing blocks for normalization and augmentation. We've also placed a convolutional layer in parallel to the ResNet layer to train the image data, which has also been customized. You can even specify the version of the ResNet architecture you want to use.</p>
			<p>Although this mode is more complex, it is much more powerful and flexible. Note that you can even specify the version of the ResNet architecture that you want to use (v2). It is important to note that for parameters (such as version) that haven't been customized, AutoKeras will try different combinations of values to find the most optimal one.</p>
			<h1 id="_idParaDest-136"><a id="_idTextAnchor139"/>Summary</h1>
			<p>In this chapter, we learned what a multitasking model is, what a multimodal model is, and how to use the powerful AutoModel class to create efficient models with multiple inputs and outputs. You are now ready to apply these concepts to your own multimodel projects by creating them from scratch or by adapting this practical example for your own datasets.</p>
			<p>In the next chapter, we will learn how to export our models and how to use a powerful visualization tool to track and visualize metrics such as loss and accuracy in real-time graphs.</p>
		</div>
	</body></html>